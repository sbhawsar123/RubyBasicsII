Fixed indentation, and refactor some repeating code through module.
